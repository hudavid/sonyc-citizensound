<link rel="stylesheet" href="//code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css">
<script src="http://jaysalvat.github.io/buzz/releases/latest/buzz.min.js"></script>
<script src="http://code.jquery.com/ui/1.8.24/jquery-ui.min.js"></script>

<div class="row">
    <!-- Success and Error Messages for the user --> 
    <div class="span6 offset2" style="height:50px">
        <div id="success" class="alert alert-success" style="display:none;">
            <a class="close">×</a>
            <strong>Well done!</strong> Your answer has been saved
        </div>
        <div id="loading" class="alert alert-info" style="display:none;">
            <a class="close">×</a>
            Loading next task...
        </div>
        <div id="taskcompleted" class="alert alert-info" style="display:none;">
            <strong>The task has been completed!</strong> Thanks a lot!
        </div>
        <div id="finish" class="alert alert-success" style="display:none;">
            <strong>Congratulations!</strong> You have participated in all available tasks!
            <br/>
            <div class="alert-actions">
                <a class="btn small" href="/">Go back</a>
                <a class="btn small" href="/app">or, Check other applications</a>
            </div>
        </div>
        <div id="error" class="alert alert-error" style="display:none;">
            <a class="close">×</a>
            <strong>Error!</strong> Something went wrong, please contact the site administrators
        </div>
    </div> <!-- End Success and Error Messages for the user -->
</div> <!-- End of Row -->

<!--
    Task DOM for loading the Flickr Images
    It uses the class="skeleton" to identify the elements that belong to the
    task.
-->
<div class="row skeleton"> <!-- Start Skeleton Row-->
    <div class="span12"><!-- Start of Question and Submission DIV (column) -->
        <h1 id="question">Label this sound clip</h1> <!-- The question will be loaded here -->
    </div>
</div>
<div class="row skeleton"> <!-- Start Skeleton Row-->
    <div class="span12"><!-- Start of Question and Submission DIV (column) -->
        <div id="spectrals"><!-- Start of Photo DIV (column) -->
        </div><!-- End of Photo DIV (columnt) -->
    <div id="slider-audio" style="margin-top:5px; width:900px"></div>
    <div id="slider-range" style="margin-top:5px; width:900px"></div>
    <div id="soundClips" class="btn-group"><!-- Start of Photo DIV (column) -->

        <button class="btn" value='Yes' id="play"><span id="play-button" class="glyphicon glyphicon-play"></span> </button>
    
        <button class="btn btn-inverse" value='No' id="stop"><span id="stop-button" class="glyphicon glyphicon-backward"></span> </button>
    
    </div>
    <span id="timer"></span>/<span id="totalTime"></span>
    <br/>

    </div><!-- End of Question and Submission DIV (column) -->
	<div class="form-row">
	<div class="span6">
	    <strong>Start Time: </strong><span id="startTime"></span>
    <strong>End Time: </strong><span id="endTime"></span>
    <span id="startTimeSeconds" style="display:none"></span>
    <span id="endTimeSeconds" style="display:none"></span>

        <form class="form-inline">

        <input type="text" name="inputTag" id="inputTag">
        <button class="btn btn-inverse btn-answer" value='addTag' id="addTag" type="button"><i class="icon icon-white icon-plus"></i> Add tag</button>

        </form> 

        <!-- Feedback items for the user -->
		 <p>The current task ID is: <span id="task-id" class="label label-info">#</span></p>
        <p>You have completed: <span id="done" class="label label-info"></span> out of
        <!-- Progress bar for the user -->
        <span id="total" class="label label-warning"></span> tasks</p>

        <div class="progress progress-striped">
            <div id="progress" rel="tooltip" title="#" class="bar" style="width: 0%;"></div>
        </div>
	</div>
	<div class="span6">
        <table id="tags-table" class="table table-striped table-bordered">
            <tbody>
            <tr>
                <th>Remove</td>
                <th>Description</td>
                <th>Start</td>
                <th>End</td>
            </tr>
            </tbody>
        </table>
        
        <!--button not finished yet -->
        <button class="btn btn-inverse btn-answer pull-right" id="submit" type="button"><i class="icon icon-white icon-plus"></i> Submit</button>
        <button class="btn btn-inverse btn-answer" id="demo" type="button"><i class="icon icon-white icon-plus"></i>Test Button</button>
        <p>Don't click these buttons on the right!(WIP)</p>
	</div>
	</div>
        <!-- 
            This application uses Disqus to allow users to provide some feedback.
            The next section includes a button that when a user clicks on it will
            load the comments, if any, for the given task
			
        <div id="disqus_show_btn" style="margin-top:5px;">
            <button class="btn btn-primary btn-large btn-disqus" onclick="loadDisqus()"><i class="icon-comments"></i> Show comments</button>
            <button class="btn btn-large btn-disqus" onclick="loadDisqus()" style="display:none"><i class="icon-comments"></i> Hide comments</button>
        </div>
		-->
		<!-- End of Disqus Button section -->
        <!-- Disqus thread for the given task -->
		<!--
        <div id="disqus_thread" style="margin-top:5px;display:none"></div>
		-->
</div><!-- End of Skeleton Row -->

<!-- entire chunk is for comments
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */

    /* * * DON'T EDIT BELOW THIS LINE * * */
    function loadDisqus() {
    $("#disqus_thread").toggle();
    $(".btn-disqus").toggle();
    var disqus_shortname = 'pybossa'; // required: replace example with your forum shortname
    //var disqus_identifier = taskId;
    var disqus_developer = 1;

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    }

</script>

<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
-->
<script>

function fromPixelsToSeconds(pixel, duration){ 
    return ((pixel * duration) / 900)
}

function fromSecondsToPixels(seconds, duration){ 
    return Math.round((secons * 900)/ duration);
}

//time is handled in milliseconds
function setCookie(cname,cvalue,expireTime) {
    var date = new Date();
    date.setTime(Date.now() + (expireTime*1000));
    var expires = "expires=" + date.toGMTString();
    document.cookie = cname+"="+cvalue+"; "+expires;    
}

function getCookie(cname) {
    var name = cname + "=";
    var cArray = document.cookie.split(';');
    for(var i = 0; i < cArray.length; i++) {
        var current = cArray[i].trim();
        if (current.indexOf(name) == 0) return current.substring(name.length, current.length);
    }
    return "";
}

function checkCookie() {
    var user=getCookie("username");
    if (user) {
        alert("Cookie in use, name is " + user + ", will be deleted in 15 seconds or less");
    }
    else {
       user = prompt("What is your name?","");
       if (user) {
           setCookie("username", user, 15);
       }
    }
}

function loadUserProgress() {
    pybossa.userProgress('sonycv1').done(function(data){
        var pct = Math.round((data.done*100)/data.total);
        $("#progress").css("width", pct.toString() +"%");
        $("#progress").attr("title", pct.toString() + "% completed!");
        $("#progress").tooltip({'placement': 'left'}); 
        $("#total").text(data.total);
        $("#done").text(data.done);
    });
}

pybossa.taskLoaded(function(task, deferred) {
    if ( !$.isEmptyObject(task) ) {
    var img = $("<img/>");

    //deferred.resolve(task);
    img.attr("src", task.info.spec_url);
    img.attr("id", "spectral_" + task.id);
    img.css("display", "none");
    img.load(function() {
            deferred.resolve(task);
    });
    task.info.img = img;

    var slider = $("<div/>");
    slider.attr("id", "slider-range-" + task.id);
    slider.css("margin-top", "5px");
    slider.css("width", "900px");
    slider.css("height", "200px");
    slider.css("background", "url(" + task.info.spec_url +")");
    slider.css("display", "none");
    task.info.slider = slider;
    //task.answer = [];
}
    else {
        deferred.resolve(task);
    }
});

pybossa.presentTask(function(task, deferred) {
    if ( !$.isEmptyObject(task) ) {
        loadUserProgress();
        checkCookie();
		$('#task-id').html(task.id);
        $("#addTag").show();
		$("#inputTag").show();
        $("#spectrals").append(task.info.slider);
		
/* disabled autocomplete list for now
         var availableTags = [
            "engine idling",
            "car horn",
            "car brakes",
            "train brakes",
            "police siren",
            "jackhammer",
            "drilling",
            "gun shot",
            "dog bark",
            "street music",
            "air conditioner",
        ];
        $( "#inputTag" ).autocomplete({
        source: availableTags
        });
*/
        $('form').submit(function(e){
            //$(this).children('input[type=submit]').attr('disabled', 'disabled');
            // this is just for demonstration
            e.preventDefault(); 
        });
/*
        $( "#inputTag" ).on( "autocompleteclose", function( event, ui ) {
                $("#addTag").removeClass("disabled");

                } );
*/
         $( "#slider-audio" ).slider({
                range: false,
                min: 0,
                max:900,
                slide: function( event, ui ) {
                    var seconds = ((ui.value * task.info.duration) / 900);
                    task.mySound.setTime(0);
                }
        });

         $( "#slider-range-" + task.id).slider({
                range: true,
                min: 0,
                max:900,
                values: [ 0, 900 ],
                slide: function( event, ui ) {
                    //$("#inputTag").show();
                    $("#addTag").show();
                    $( "#startTime" ).text( buzz.toTimer(fromPixelsToSeconds(ui.values[ 0 ], task.info.duration), true ));
                    $( "#startTimeSeconds" ).text( (fromPixelsToSeconds(ui.values[ 0 ], task.info.duration) ));
                    $( "#endTime" ).text(buzz.toTimer(fromPixelsToSeconds(ui.values[ 1 ], task.info.duration), true ) );
                    $( "#endTimeSeconds" ).text((fromPixelsToSeconds(ui.values[ 1 ], task.info.duration) ) );
                }
        });

        $(".ui-slider-range").css("opacity", "0.5");
        $(".ui-slider-range").css("cursor", "col-resize");
        $("#slider-range-" + task.id + " .ui-slider-handle").css("height", "100%");
        $("#slider-range-" + task.id + " .ui-slider-handle").css("width", "1px");
        $("#slider-range-" + task.id + " .ui-slider-handle").css("top", "0");
        $("#slider-range-" + task.id + " .ui-slider-handle").css("margin-left", "0");
        //$(".ui-slider-range ui-widget-header").css("opacity", "0.5");
        $(".ui-slider-range").css("background", "rgba(255,255,255,0.7)");


        $("#slider-range-" + task.id).show();
		task.mySound = null;
        task.mySound = new buzz.sound(task.info.clip_url, {
                autoplay: true,
		    }
        );

		task.mySound.load();
		
        $("#totalTime").text(buzz.toTimer( task.info.duration ));
        $('#play').on('click', function(){
            task.mySound.togglePlay();
            $('#play-button').toggleClass('glyphicon-play glyphicon-pause');
	    });

        $('#stop').on('click', function(){
            task.mySound.stop();
	    });

        task.mySound.bind("timeupdate", function(e) {
            var timer = buzz.toTimer(this.getTime());

            var position = Math.round((this.getTime() * 900)/ task.info.duration);
            $( "#slider-audio" ).slider( "option", "value", position );
            $("#timer").text(timer);
        });

        /* TODO - Not working
        $('#demo').off('click').on('click', function(){
            var table = document.getElementById("tags-table");
            var row = table.insertRow(-1);
            for (i = 0; i < 4; i++) {
                row.insertCell(i);
                table.rows[i].cells[-1].innerHTML = "hi";
            }
        }
        */
        
        $('.btn-answer').off('click').on('click', function(evt) {
            var answer = $(evt.target).attr("value");
            if ((typeof answer != 'undefined') && (answer == 'addTag')) {
            //add in "name" field to test cookie storage
                var tag =  {tag: $("#inputTag").val(),
                            cue:{'start': parseFloat($("#startTimeSeconds").text()),
                                 'end': parseFloat($("#endTimeSeconds").text())},
                            name: getCookie("username")
                            };
                pybossa.saveTask(task.id, tag).done(function() {
                    $("#slider-range-" + task.id).remove();
                    $("#inputTag").hide();
                    $("#inputTag").val("");
                    //$("#inputTag").addClass("disabled");
                    task.mySound.unbind("timeupdate");
                    task.mySound.stop();
                    //task.mySound = null;
                    console.log(buzz.sounds);
                    buzz.sounds = [];
                    console.log(buzz.sounds);
                    $("#addTag").hide();
                    deferred.resolve();

                });
                $("#loading").fadeIn(500);
				/*
                if ($("#disqus_thread").is(":visible")) {
                    $('#disqus_thread').toggle();
                    $('.btn-disqus').toggle();
                }
				*/
            }
            else {
                $("#error").show();
            }
        });

        $("#loading").hide();
    }
    else {
        $(".skeleton").hide();
        $("#loading").hide();
        $("#finish").fadeIn(500);
    }
});

pybossa.run('sonycv1');
</script>