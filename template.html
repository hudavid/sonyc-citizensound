<link rel="stylesheet" href="//code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css">
<script src="http://code.jquery.com/ui/1.8.24/jquery-ui.min.js"></script>

<div class="row">
    <!-- Success and Error Messages for the user --> 
    <div class="span6 offset2" style="height:50px">
        <div id="success" class="alert alert-success" style="display:none;">
            <a class="close">×</a>
            <strong>Well done!</strong> Your answer has been saved
        </div>
        <div id="loading" class="alert alert-info" style="display:none;">
            <a class="close">×</a>
            Loading next task...
        </div>
        <div id="taskcompleted" class="alert alert-info" style="display:none;">
            <strong>The task has been completed!</strong> Thanks a lot!
        </div>
        <div id="finish" class="alert alert-success" style="display:none;">
            <strong>Congratulations!</strong> You have participated in all available tasks!
            <br/>
            <div class="alert-actions">
                <a class="btn small" href="/">Go back</a>
                <a class="btn small" href="/app">or, Check other applications</a>
            </div>
        </div>
        <div id="error" class="alert alert-error" style="display:none;">
            <a class="close">×</a>
            <strong>Error!</strong> Something went wrong, please contact the site administrators
        </div>
    </div> <!-- End Success and Error Messages for the user -->
</div> <!-- End of Row -->

<!--
    Task DOM for loading the Flickr Images
    It uses the class="skeleton" to identify the elements that belong to the
    task.
-->
<div class="row skeleton"> <!-- Start Skeleton Row-->
    <div class="span12"><!-- Start of Question and Submission DIV (column) -->
        <h1 id="question">Label this sound clip</h1> <!-- The question will be loaded here -->
    </div>
</div>
<div> <!-- Start Skeleton Row-->
    <div class="span12"><!-- Start of Question and Submission DIV (column) -->
        <div id="spectrals">
        </div>
    <div>
        <audio id="soundclip" autoplay preload="auto">
        <p>Your browser doesn't support audio elements</p>
        </audio>
        <div id="playslider" style="margin-top:5px">
        </div>
        <button class="btn" id="play"><span id="play-button" class="glyphicon glyphicon-play"></span> </button>
    
        <button class="btn" id="stop"><span id="stop-button" class="glyphicon glyphicon-backward"></span> </button>
        <span id="slider-current">00:00:00 / 00:00:00
        </span>
        <div id="debug">
        </div>
    </div>
    </div><!-- End of Question and Submission DIV (column) -->
    <div class="span12">
        <div class="span3">
        <p class="text-center"><strong>Salience</strong></p>
        </div>
        <div class="span9">
            <form class="form">
                <input type="radio" name="salience" value="foreground" checked> Foreground
                <input type="radio" name="salience" value="background"> Background
                <input type="radio" name="salience" value="not sure"> Not Sure
            </form>
        </div>
    </div>
	<div class="span12">
    
        <!-- Feedback items for the user -->
        <div class="span3">
        <p class="text-center"><strong>Select Tags</strong></p>
        </div>
        <div class="span9">
        <div class="btn-group btn-group-sm">
        <button id="preset-tag" class="btn btn-default" value="air conditioner">Air Conditioner</button>
        <button id="preset-tag" class="btn btn-default" value="car horn">Car Horn</button>
        <button id="preset-tag" class="btn btn-default" value="children playing">Children Playing</button>
        <button id="preset-tag" class="btn btn-default" value="dog bark">Dog Bark</button>
        <button id="preset-tag" class="btn btn-default" value="drilling">Drilling</button>
        <button id="preset-tag" class="btn btn-default" value="engine idling">Engine Idling</button>
        <button id="preset-tag" class="btn btn-default" value="gun shot">Gun Shot</button>
        <button id="preset-tag" class="btn btn-default" value="jackhammer">Jack Hammer</button>
        <button id="preset-tag" class="btn btn-default" value="siren">Siren</button>
        <button id="preset-tag" class="btn btn-default" value="street music">Street Music</button>
        </div>
        </div>
    </div>
    
    <div class="span12">
        <div class="span3">
        <p class="text-center"><strong>Custom Tags</strong></p>
        </div>
        <div class="span9">
        <form class="form">
        <input id="custom-input" type="text" name="inputTag" id="inputTag" placeholder="custom tag">
        <button class="btn btn-inverse" value='addTag' id="addTag" type="button"><i class="glyphicon icon-white glyphicon-plus"></i></button>
        </form> 
        </div>
    </div>
    <div class="span12">
        <div class="span4 btn-group-vertical btn-group-sm" id="selected-fg" style="border: 1px solid">
            <p class="text-center"><strong>Foreground</strong></p>
        </div>
        <div class="span4 btn-group-vertical btn-group-sm" id="selected-bg" style="border: 1px solid">
            <p class="text-center"><strong>Background</strong></p>
        </div>
        <div class="span4 btn-group-vertical btn-group-sm" id="selected-uk" style="border: 1px solid">
            <p class="text-center"><strong>Unsure</strong></p>
        </div>
    </div>
    <div class="span12">
        <button class="btn btn-inverse btn-answer pull-right btn-answer" id="submit" type="button"><i class="icon icon-white icon-plus"></i> Submit</button>
    </div>
    <button class="btn btn-inverse btn-sm" id="toggle-info" type="button">Show/Hide Details</button>
    <div id="extra-info" style="display:none">
		 <p>The current task ID is: <span id="task-id" class="label label-info">#</span></p>
        <p>You have completed: <span id="done" class="label label-info"></span> out of
        <!-- Progress bar for the user -->
        <span id="total" class="label label-warning"></span> tasks</p>

        <div class="progress progress-striped">
            <div id="progress" rel="tooltip" title="#" class="progress-bar" style="width: 0%;"></div>
        </div>
	</div>
</div>
        <!-- 
            This application uses Disqus to allow users to provide some feedback.
            The next section includes a button that when a user clicks on it will
            load the comments, if any, for the given task
			
        <div id="disqus_show_btn" style="margin-top:5px;">
            <button class="btn btn-primary btn-large btn-disqus" onclick="loadDisqus()"><i class="icon-comments"></i> Show comments</button>
            <button class="btn btn-large btn-disqus" onclick="loadDisqus()" style="display:none"><i class="icon-comments"></i> Hide comments</button>
        </div>
		-->
		<!-- End of Disqus Button section -->
        <!-- Disqus thread for the given task -->
		<!--
        <div id="disqus_thread" style="margin-top:5px;display:none"></div>
		-->
<!-- End of Skeleton Row -->

<!-- entire chunk is for comments
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */

    /* * * DON'T EDIT BELOW THIS LINE * * */
    function loadDisqus() {
    $("#disqus_thread").toggle();
    $(".btn-disqus").toggle();
    var disqus_shortname = 'pybossa'; // required: replace example with your forum shortname
    //var disqus_identifier = taskId;
    var disqus_developer = 1;

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    }

</script>

<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
-->
<script>

function fromPixelsToSeconds(pixel, duration){ 
    return ((pixel * duration) / 900)
}

function fromSecondsToPixels(seconds, duration){ 
    return Math.round((secons * 900)/ duration);
}

//GUID generator code adapted from http://guid.us/
function S4() {
    return (((1+Math.random())*0x10000)|0).toString(16).substring(1);
}
 
function GUID() {
    return (S4() + S4() + "-" + S4() + "-4" + S4().substr(0,3) + "-" + S4() + "-" + S4() + S4() + S4()).toLowerCase();
}

//time is handled in milliseconds
function setCookie(cname,cvalue,expireTime) {
    var date = new Date();
    date.setTime(Date.now() + (expireTime*1000));
    var expires = "expires=" + date.toGMTString();
    document.cookie = cname+"="+cvalue+"; "+expires;
}

function getCookie(cname) {
    var name = cname + "=";
    var cArray = document.cookie.split(';');
    for(var i = 0; i < cArray.length; i++) {
        var current = cArray[i].trim();
        if (current.indexOf(name) == 0) return current.substring(name.length, current.length);
    }
    return "";
}

function checkCookie() {
    var uniqueID = getCookie("uid");
    if (!uniqueID) {
       alert("Hello new contributor! Cookie is now set to last 30 minutes");
       //cookie lasts for 5 minutes for now, change time to something realistic later
       uniqueID = GUID();
       setCookie("uid", uniqueID, 1800);
    }
}

//from seconds to minutes:seconds.milliseconds
function secondsToTime(input) {
    var minutes = Math.floor(input / 60);
    if (minutes < 10) {
        minutes = "0"+minutes;
    }
    var seconds = (input - (minutes * 60)).toFixed(2);
    if (seconds < 10) {
        seconds = "0"+seconds;
    }
    return minutes+":"+seconds;
}

function addNewTag(newtag) {
            var salience = $("input[name=salience]:checked").val();
            var elementToAdd = $("<button>", {
                type: "button",
                value: newtag,
                text: newtag,
                class: "btn btn-default selected",
                //id: "selected"
            });
            elementToAdd.on('click', function(evt) {
                $(this).remove();
            });
            /* when hover, show X icon instead
            elementToAdd.hover(function() {
                $(this).toggleClass('btn-default btn-danger');
            });
            */
            elementToAdd.css("margin", "5px");
            
            switch(salience) {
                case "foreground":
                    elementToAdd.attr('id', 'tag-fg');
                    $("#selected-fg").append(elementToAdd);
                    break;
                case "background":
                    elementToAdd.attr('id', 'tag-bg');
                    $("#selected-bg").append(elementToAdd);
                    break;
                default:
                    elementToAdd.attr('id', 'tag-un');
                    $("#selected-uk").append(elementToAdd);
            }
}

function getTags() {
    var fg = $('[id=tag-fg]');
    var bg = $('[id=tag-bg]');
    var un = $('[id=tag-un]');
    
    var tags = {};
    tags.foreground = new Array();
    for (i = 0; i < fg.length; i++) {
        tags.foreground.push(fg[i].value);
    }
    
    tags.background = new Array();
    for (i = 0; i < bg.length; i++) {
        tags.background.push(bg[i].value);
    }
    
    tags.unsure = new Array();
    for (i = 0; i < un.length; i++) {
        tags.unsure.push(un[i].value);
    }
    return tags;
}

function loadUserProgress() {
    pybossa.userProgress('sonycv1').done(function(data){
        var pct = Math.round((data.done*100)/data.total);
        $("#progress").css("width", pct.toString() +"%");
        $("#progress").attr("title", pct.toString() + "% completed!");
        $("#progress").tooltip({'placement': 'left'}); 
        $("#total").text(data.total);
        $("#done").text(data.done);
    });
}

pybossa.taskLoaded(function(task, deferred) {
    if ( !$.isEmptyObject(task) ) {
    var img = $("<img/>");

    //deferred.resolve(task);
    img.attr("src", task.info.spec_url);
    img.attr("id", "spectral_" + task.id);
    img.attr("width", "100%");
    img.load(function() {
            deferred.resolve(task);
    });
    task.info.img = img;
    
    //task.answer = [];
}
    else {
        deferred.resolve(task);
    }
});

pybossa.presentTask(function(task, deferred) {
    if ( !$.isEmptyObject(task) ) {
        loadUserProgress();
        checkCookie();
		$('#task-id').html(task.id);
        //$("#addTag").show();
		//$("#inputTag").show();
        $("#spectrals").html(task.info.img);
		$("#soundclip").attr("src", task.info.clip_url);
        //$("#soundclip").attr("ontimeupdate", "updateSound()");
        $("#soundclip").load();
        $("[id=preset-tag]").css("margin", "2px");
        
        var soundclip = document.getElementById("soundclip");
        var playslider = document.getElementById("playslider");
        
        $("#playslider").slider({
            range: false,
            min: 0,
            max: (task.info.duration).toFixed(2),
            step: 0.01,
            slide: function(event, ui) {
                soundclip.currentTime = $(this).slider("value");
            }
        });
        
        $("#soundclip").on("timeupdate", function(e) {
            $(playslider).slider("option", "value", soundclip.currentTime);
            var sliderCurrent = document.getElementById("slider-current");
            sliderCurrent.innerHTML =  secondsToTime(soundclip.currentTime) + ' / ' + secondsToTime(soundclip.duration);
        });
        
        $("#play").on("click", function() {
            if (soundclip.paused) {
                soundclip.play();
            }
            else {
                soundclip.pause();
            }
            $("#play-button").toggleClass('glyphicon-play glyphicon-pause');
        });
        
        $("#stop").on("click", function() {
            soundclip.currentTime = 0;
        });
        
        $("[id=preset-tag]").on("click", function() {
            var newtag = $(this).val();
            addNewTag(newtag);
        });
        
        //re-enabled autocomplete again
         var availableTags = [
            "engine idling",
            "car horn",
            "car brakes",
            "train brakes",
            "police siren",
            "jackhammer",
            "drilling",
            "gun shot",
            "dog bark",
            "street music",
            "air conditioner",
        ];
        
        $( "#custom-input" ).autocomplete({
            source: availableTags
        });

        $("#addTag").on("click", function(evt) {
            var newtag = $("#custom-input").val();
            addNewTag(newtag);
        });

        $('form').submit(function(e){
            //$(this).children('input[type=submit]').attr('disabled', 'disabled');
            // this is just for demonstration
            e.preventDefault(); 
        });

        $( "#custom-input" ).on( "autocompleteclose", function( event, ui ) {
                $("#addTag").removeClass("disabled");

                } );
        
        $("#toggle-info").on("click", function(evt) {
            $("#extra-info").toggle();        
        });
        
        $('.btn-answer').off('click').on('click', function(evt) {
            var answer = $(evt.target).attr("value");
            //if ((typeof answer != 'undefined') && (answer == 'addTag')) {
            if (true) {
            //add in "name" field to test cookie storage
                var tag = getTags();
                tag.uid = getCookie("uid");
                pybossa.saveTask(task.id, tag).done(function() {
                    
                    $("#inputTag").hide();
                    $("#inputTag").val("");
                    //$("#inputTag").addClass("disabled");
                    $("#addTag").hide();
                    deferred.resolve();

                });
                $("#loading").fadeIn(500);
				/*
                if ($("#disqus_thread").is(":visible")) {
                    $('#disqus_thread').toggle();
                    $('.btn-disqus').toggle();
                }
				*/
            }
            else {
                $("#error").show();
            }
        });
        
        $("#loading").hide();
    }
    else {
        $(".skeleton").hide();
        $("#loading").hide();
        $("#finish").fadeIn(500);
    }
});

pybossa.run('sonycv1');
</script>